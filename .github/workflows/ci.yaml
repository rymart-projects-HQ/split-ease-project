name: Node.js CI

on:
  pull_request:
    branches:
      - main
      - staging
  push:
    branches:
      - staging

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      - name: use node.js
        uses: actions/setup-node@v4
        with:
          node-version: v24.12.0
      - name: Install dependencies
        run: npm ci
      - name: Run lint
        run: npm run lint:fix

  test-failure:
    name: Test Failure Alert
    runs-on: ubuntu-latest

    steps:
      - name: This will fail
        run: exit

  # Discord Alert
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [lint, test-failure]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/staging')

    steps:
      - name: Send Discord notification
        run: |
          curl -H "Content-Type: application/json" \
              -d '{
                "content": "ðŸš¨ **CI Pipeline Failed**",
                "embeds": [{
                  "title": "Workflow: ${{ github.workflow }}",
                  "description": "Branch: `${{ github.ref_name }}`\nCommit: `${{ github.sha }}`\nAuthor: ${{ github.actor }}",
                  "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}",
                  "color": 15158332
                }]
              }' \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lint]
    if: always()

    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.lint.result }}" != "success" ]; then
            echo "One or more CI jobs failed"
            exit 1
          fi
          echo "All CI jobs passed successfully"
